rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isSuperAdmin() {
      return isAdmin() &&
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super_admin';
    }

    function isCoach() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/coaches/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function validTimestamp(field) {
      return request.resource.data[field] is timestamp;
    }

    // Sessions - public read for booking, admin write
    match /sessions/{sessionId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Session Options - public read, admin write
    match /sessionOptions/{optionId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Bookings - owner read, admin full access
    match /bookings/{bookingId} {
      allow read: if isAdmin() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // Users - owner access to own data, admin full access
    match /users/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();

      // Children subcollection
      match /children/{childId} {
        allow read: if isAdmin() || isOwner(userId);
        allow write: if isOwner(userId) || isAdmin();
      }
    }

    // Admins - only super_admin can manage, admins can read
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }

    // Coaches - admin write, coach read own
    match /coaches/{coachId} {
      allow read: if isAdmin() || isOwner(coachId);
      allow write: if isAdmin();
    }

    // Coach permissions
    match /coachPermissions/{permId} {
      allow read: if isAdmin() ||
        (isCoach() && resource.data.coachId == request.auth.uid);
      allow write: if isAdmin();
    }

    // Coupons - admin only
    match /coupons/{couponId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Discounts - admin only
    match /discounts/{discountId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Waivers - public read (for checkout), admin write
    match /waivers/{waiverId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Forms - public read (for checkout), admin write
    match /forms/{formId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Payment Plans - admin only
    match /paymentPlans/{planId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Scheduled Reports - admin only
    match /scheduledReports/{reportId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Attendance - admin and coach access
    match /attendance/{attendanceId} {
      allow read: if isAdmin() || isCoach();
      allow write: if isAdmin() || isCoach();
    }

    // Campaigns (emails) - admin only
    match /campaigns/{campaignId} {
      allow read, write: if isAdmin();
    }

    // Analytics - admin only
    match /analytics/{docId} {
      allow read, write: if isAdmin();
    }

    // Debug tests - super admin only, development
    match /_debug_tests/{testId} {
      allow read, write: if isSuperAdmin();
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
